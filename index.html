<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrohomeservise - All Maintenance Needs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@17/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@17/build/js/intlTelInput.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Global Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #555b63; 
            background-image: url('one.jpg'); 
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }

        /* Section Title Underline Custom Class */
        .section-title {
            position: relative;
            display: inline-block;
            padding-bottom: 0.5rem;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50%;
            height: 4px;
            background-color: #1e40af; /* Blue-800 */
            border-radius: 9999px;
        }

        /* --- Cartoon Greeting Popup Styles --- */
        #cartoon-greeting {
            position: fixed;
            left: 1rem;
            bottom: 1rem;
            width: 320px;
            max-width: calc(100% - 2rem);
            z-index: 80;
            display: none;
            pointer-events: auto;
            animation: cg-slide-up 500ms ease forwards;
        }
        #cartoon-greeting .card {
            display:flex; gap:0.75rem; align-items:flex-start;
            background: linear-gradient(180deg,#fff,#f8fafc);
            border-radius: 12px; padding: 0.75rem 0.9rem;
            box-shadow: 0 12px 30px rgba(2,6,23,0.25);
        }
        #cartoon-greeting .cartoon {
            width:72px; height:72px; flex:0 0 72px;
        }
        #cartoon-greeting .bubble {
            flex:1;
        }
        #cartoon-greeting .bubble h4 { margin:0 0 4px 0; font-weight:700; color:#0f172a; font-size:15px; }
        #cartoon-greeting .bubble p { margin:0; font-size:13px; color:#475569; }
        #cartoon-greeting .actions { margin-top:8px; display:flex; gap:8px; align-items:center; }
        #cartoon-greeting .btn {
            background:#0ea5a4; color:#fff; padding:6px 10px; border-radius:8px; font-size:13px; text-decoration:none;
            transition: background 150ms;
        }
        #cartoon-greeting .btn:hover { background: #0f767a; }

        #cartoon-greeting .close {
            background:transparent; border:0; font-size:18px; color:#6b7280; cursor:pointer; margin-left:6px;
        }
        #cartoon-greeting .muted { font-size:12px; color:#94a3b8; display:flex; align-items:center; gap:6px; margin-left:auto; }
        @keyframes cg-slide-up { from { transform: translateY(20px) scale(.98); opacity:0 } to { transform: translateY(0) scale(1); opacity:1 } }
        @media (prefers-reduced-motion: reduce) { #cartoon-greeting { animation: none; } }
        /* --- End Cartoon Greeting Popup Styles --- */

        /* --- Floating Call & Chat widget Styles --- */
        #fh-widget { 
            position: fixed; 
            right: 1rem; 
            bottom: 1rem; 
            z-index: 90; 
            display: flex; 
            flex-direction: column; 
            gap: 0.6rem; 
        }
        .fh-btn { 
            display: inline-flex; 
            align-items:center; 
            gap:8px; 
            padding:10px 12px; 
            border-radius:999px; 
            box-shadow:0 8px 20px rgba(2,6,23,0.15); 
            color:#fff; 
            text-decoration:none; 
            font-weight:600; 
            font-size:14px; 
            transition: transform 150ms;
        }
        .fh-btn:hover {
             transform: translateY(-2px);
        }
        .fh-chat { background: #25D366; } /* WhatsApp green */
        .fh-call { background: #0ea5a4; } /* teal */
        .fh-icon { width:20px; height:20px; display:inline-block; }
        @media (max-width:420px){ 
            .fh-btn { padding:10px; font-size:13px } 
        }
        /* --- End Floating Call & Chat widget Styles --- */
    </style>
</head>
<body class="text-gray-800">
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-700">Astrohomeservise</div>
            <nav class="hidden md:flex space-x-6 text-sm font-medium">
                <a href="#services" class="hover:text-indigo-600 transition duration-150">Our Services</a>
                <a href="#how-it-works" class="hover:text-indigo-600 transition duration-150">How It Works</a>
                <a href="#trust" class="hover:text-indigo-600 transition duration-150">Why Trust Us</a>
                <a href="#contact" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150">Get Quote</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="bg-indigo-700 text-white pt-16 pb-20 sm:pt-24 sm:pb-32">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-6xl font-extrabold leading-tight mb-4">
                    Your Single Connection for <span class="text-yellow-300">Every Home Need</span>
                </h1>
                <p class="text-xl sm:text-2xl font-light mb-8 max-w-3xl mx-auto">
                    From fixing leaks to full renovations, we vet the best local experts so you don't have to. Get started with a free estimate today.
                </p>
                <a href="#contact" class="inline-block px-10 py-4 bg-yellow-400 text-indigo-900 font-bold text-lg rounded-full shadow-2xl hover:bg-yellow-300 transform hover:scale-105 transition duration-300">
                    Request Your Free Quote
                </a>
            </div>
        </section>

        <section id="services" class="py-20 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold mb-12 section-title mx-auto text-center">Our Vetted Service Categories</h2>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">

                    <div class="bg-gray-50 p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border-t-4 border-blue-500">
                        <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21h7a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h4m5 0v-5h4v5m-4 0h-4M9 11v5h6v-5H9z"></path></svg>
                        <h3 class="text-xl font-semibold mb-2">Plumbing & HVAC</h3>
                        <p class="text-gray-600 text-sm">Leak fixes, water heater installation, drain clearing, and comprehensive heating/cooling maintenance.</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border-t-4 border-green-500">
                        <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <h3 class="text-xl font-semibold mb-2">Home Renovation</h3>
                        <p class="text-gray-600 text-sm">Kitchen and bathroom remodels, interior painting, drywall, carpentry, and custom gate/fence construction.</p>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border-t-4 border-yellow-500">
                        <svg class="w-10 h-10 text-yellow-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10v11l6-2 6 2 6-2V10M3 10a2 2 0 012-2h14a2 2 0 012 2M3 10V5a2 2 0 012-2h14a2 2 0 012 2v5"></path></svg>
                        <h3 class="text-xl font-semibold mb-2">Detailed Cleaning</h3>
                        <p class="text-gray-600 text-sm">Deep cleaning, scheduled maid services, specialized vehicle detailing (car, boat, RV), and power washing.</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border-t-4 border-red-500">
                        <svg class="w-10 h-10 text-red-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <h3 class="text-xl font-semibold mb-2">Roofing & Exterior</h3>
                        <p class="text-gray-600 text-sm">Roof cleaning, moss removal, minor repairs, gutter installation, and exterior painting/staining.</p>
                    </div>

                </div>
            </div>
        </section>
        
        <section id="how-it-works" class="py-20 bg-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold mb-12 section-title text-center">How Our System Works</h2>
                <div class="grid md:grid-cols-3 gap-8 text-center">
                    
                    <div class="p-6 bg-white rounded-xl shadow-lg">
                        <div class="text-4xl font-extrabold text-indigo-600 mb-3">1</div>
                        <h4 class="text-xl font-semibold mb-2">Submit Your Request</h4>
                        <p class="text-gray-600">Fill out our simple form below describing the service you need (plumbing, painting, etc.).</p>
                    </div>
                    
                    <div class="p-6 bg-white rounded-xl shadow-lg">
                        <div class="text-4xl font-extrabold text-indigo-600 mb-3">2</div>
                        <h4 class="text-xl font-semibold mb-2">We Review & Connect</h4>
                        <p class="text-gray-600">Our management team contacts the specialized partner immediately. We act as the liaison to confirm scope.</p>
                    </div>
                    
                    <div class="p-6 bg-white rounded-xl shadow-lg">
                        <div class="text-4xl font-extrabold text-indigo-600 mb-3">3</div>
                        <h4 class="text-xl font-semibold mb-2">Get Service & Quote</h4>
                        <p class="text-gray-600">The vetted service provider contacts you directly to finalize the quote and schedule the work.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="trust" class="py-20 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold mb-12 section-title mx-auto text-center">Why Trust Our KwaZulu-Natal Service Partners?</h2>
                <p class="text-center text-lg text-gray-600 mb-12 max-w-3xl mx-auto">
                    We don't just list businesses; we build partnerships. Every contractor, from the plumber to the renovator, is held to a rigorous standard to ensure quality service across the entire KZN province.
                </p>

                <div class="grid md:grid-cols-3 gap-8 text-center">
                    
                    <div class="p-6 bg-indigo-50 rounded-xl shadow-lg">
                        <svg class="w-10 h-10 text-indigo-600 mb-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002.944 12c.048.974.291 1.944.78 2.853m8.261-2.853C14.045 9.42 16.598 8.133 19 8.047v.558a2 2 0 01-.482 1.258m-4.004-4.004h-.002"></path></svg>
                        <h4 class="text-xl font-semibold mb-2">Licensed & Insured</h4>
                        <p class="text-gray-600 text-sm">All partners provide up-to-date certification and liability insurance, protecting your home and property.</p>
                    </div>
                    
                    <div class="p-6 bg-indigo-50 rounded-xl shadow-lg">
                        <svg class="w-10 h-10 text-indigo-600 mb-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h4 class="text-xl font-semibold mb-2">KZN Regulatory Compliant</h4>
                        <p class="text-gray-600 text-sm">Partners are registered local businesses adhering to all KwaZulu-Natal trade standards and safety protocols.</p>
                    </div>
                    
                    <div class="p-6 bg-indigo-50 rounded-xl shadow-lg">
                        <svg class="w-10 h-10 text-indigo-600 mb-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.633a1.996 1.996 0 01-1.895-1.344L6.37 14.894a2 2 0 011.789-2.894H12a2 2 0 002-2V7a2 2 0 00-2-2h-3a2 2 0 00-2 2v5h.001"></path></svg>
                        <h4 class="text-xl font-semibold mb-2">98% Satisfaction Rating</h4>
                        <p class="text-gray-600 text-sm">Partners are continuously monitored for service quality and post-job customer feedback.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="contact" class="py-20 bg-indigo-50">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold mb-8 section-title mx-auto text-center">Request Your Free Estimate</h2>
                <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl">
                    
                    <form id="quoteForm" class="space-y-6" data-dirty="false">
                        
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="name" name="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        </div>
                        
                        <div class="grid sm:grid-cols-2 gap-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" id="phone" name="phone" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                        </div>

                        <div>
                            <label for="locationAddress" class="block text-sm font-medium text-gray-700">Location Address / Area (e.g., Durban North, Pinetown, Pietermaritzburg)</label>
                            <input type="text" id="locationAddress" name="locationAddress" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Street address or area in KZN">
                            <div class="mt-2 flex flex-wrap gap-2 items-center">
                                <button type="button" id="shareLocationBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700">Use my device location</button>
                                <button type="button" id="shareViaWebBtn" class="px-3 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700">Share location (Phone)</button>
                                <button type="button" id="copyLocationBtn" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-md text-sm hover:bg-gray-200">Copy location link</button>
                            </div>
                            <p id="locationStatus" class="text-xs text-gray-500 mt-2">If you can't type the address, tap "Use my device location".</p>
                        </div>

                        <div>
                            <label for="serviceType" class="block text-sm font-medium text-gray-700">Type of Service Needed</label>
                            <select id="serviceType" name="serviceType" required class="mt-1 block w-full px-4 py-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option value="" disabled selected>Select a Service Category</option>
                                <option value="Plumbing">Plumbing & HVAC</option>
                                <option value="Renovation">Home Renovation/Painting/Gate</option>
                                <option value="Cleaning">Home/Car Detailing & Cleaning</option>
                                <option value="Roofing">Roof Cleaning & Exterior Maintenance</option>
                                <option value="Other">Other Home Service</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="details" class="block text-sm font-medium text-gray-700">Details of Your Request (Required)</label>
                            <textarea id="details" name="details" rows="4" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., 'My kitchen sink is leaking and needs immediate repair.'"></textarea>
                        </div>

                        <div id="bookingOptions" class="grid sm:grid-cols-2 gap-6">
                            <div>
                                <label for="preferredDate" class="block text-sm font-medium text-gray-700">Preferred Date</label>
                                <input type="text" id="preferredDate" name="preferredDate" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Select a date">
                            </div>
                            <div>
                                <label for="preferredTime" class="block text-sm font-medium text-gray-700">Preferred Time Slot</label>
                                <select id="preferredTime" name="preferredTime" class="mt-1 block w-full px-4 py-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                    <option value="">Choose a time</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex items-center">
                            <input id="flexibleDates" name="flexibleDates" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="flexibleDates" class="ml-2 block text-sm text-gray-700">
                                I'm flexible with dates ‚Äî manager may contact me to reschedule
                            </label>
                        </div>
                        
                        <div>
                            <label for="images" class="block text-sm font-medium text-gray-700">Attach Photos (optional)</label>
                            <input id="images" name="images" type="file" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-700">
                            <div id="imagePreview" class="mt-3 flex flex-wrap"></div>
                            <p class="text-xs text-gray-500 mt-1">Attach up to 6 photos to help describe the issue. Images are previewed client-side.</p>
                        </div>
                        
                        <input type="hidden" id="depositAmount" name="depositAmount" value="50.00">
                        <input type="hidden" id="currency" name="currency" value="ZAR">

                        <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 transform hover:scale-[1.01]">
                            Submit Request & Start Quote
                        </button>
                    </form>

                    <div id="successMessage" class="hidden mt-6 p-6 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-lg" role="alert">
                        <p class="font-bold">Lead Submission Successful!</p>
                        <p>Thank you, <span id="successName" class="font-semibold"></span>! Your details have been secured.</p>
                        <p class="mt-2 text-sm text-green-800 font-semibold">
                            ‚ö†Ô∏è ACTION REQUIRED: Your WhatsApp application should open with the lead details pre-filled. **Please tap 'Send' to dispatch the lead immediately to the manager.**
                        </p>
                        <p class="mt-2 text-sm text-green-800">*(Lead data is also logged in the browser console for manual forwarding to: `astroworldwideservice.net@gmail.com`)*</p>
                    
                        <div id="depositNote" class="mt-4 text-sm text-gray-700 bg-yellow-50 p-3 rounded">
                            Optional deposit or booking confirmation may be required. <em>Server integration is required to enable automated payments.</em>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p>¬© <span id="currentYear"></span> Astrohomeservise. All Rights Reserved.</p>
            <p class="mt-2 text-xs text-gray-400">Disclaimer: We are a lead generation and management service. All work is performed by vetted, independent third-party contractors.</p>
            
            <div class="mt-6 pt-4 border-t border-gray-700 flex justify-center space-x-6">
                
                <a href="#" class="text-gray-400 hover:text-indigo-400 transition duration-300" aria-label="Find us on Facebook">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h3.295l-.527 2.987h-2.768v7.048C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" />
                    </svg>
                </a>

                <a href="#" class="text-gray-400 hover:text-indigo-400 transition duration-300" aria-label="Follow us on Instagram">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.71.01 3.664.047 2.454.09 3.978.83 4.935 1.78.955.95 1.7.93 1.75.967.04.03.07.05.09.07a.64.64 0 01-.1.2c-.05.08-.1.14-.15.2-1.02.97-2.61 1.77-4.63 1.83-1.09.03-1.4.04-3.79.04-2.4 0-2.71-.01-3.79-.04-2.02-.06-3.61-.86-4.63-1.83-.05-.06-.1-.12-.15-.2a.64.64 0 01-.1-.2.43.43 0 01.1-.2c.05-.03.08-.05.12-.07.955-.95 2.48-1.7 4.93-1.78.95-.03 1.23-.04 3.66-.04zm-.62 4.02c-3.1 0-5.61 2.51-5.61 5.61s2.51 5.61 5.61 5.61 5.61-2.51 5.61-5.61-2.51-5.61-5.61-5.61zm0 9.22a3.61 3.61 0 110-7.22 3.61 3.61 0 010 7.22zm4.35-7.79c-.74 0-1.34.6-1.34 1.34s.6 1.34 1.34 1.34 1.34-.6 1.34-1.34-.6-1.34-1.34-1.34z" clip-rule="evenodd" />
                    </svg>
                </a>
            </div>
            </div>
    </footer>

    <div id="cartoon-greeting" role="dialog" aria-live="polite" aria-label="Greeting">
        <div class="card" role="group" aria-hidden="false">
            <div class="cartoon" aria-hidden="true">
                <svg viewBox="0 0 120 120" width="72" height="72" xmlns="http://www.w3.org/2000/svg" role="img" focusable="false">
                    <defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#fef3c7"/><stop offset="1" stop-color="#fde68a"/></linearGradient></defs>
                    <rect width="120" height="120" rx="18" fill="#eef2ff"/>
                    <g transform="translate(12,12)">
                        <circle cx="42" cy="26" r="16" fill="#ffedd5"/>
                        <path d="M26 44c6-6 24-6 30 0v18H26V44z" fill="#111827" opacity="0.06"/>
                        <rect x="6" y="52" width="72" height="18" rx="8" fill="#0ea5a4" opacity="0.12"/>
                        <circle cx="42" cy="26" r="16" fill="url(#g)" opacity="0.18"/>
                        <circle cx="36" cy="22" r="2" fill="#111827"/>
                        <circle cx="48" cy="22" r="2" fill="#111827"/>
                        <path d="M36 30c4 3 8 3 10 0" stroke="#111827" stroke-width="2" stroke-linecap="round" fill="none"/>
                    </g>
                </svg>
            </div>
            <div class="bubble">
                <h4>Hi there! üëã</h4>
                <p>Need help booking a date or have a question? I can guide you ‚Äî tap below to jump to the form.</p>
                <div class="actions">
                    <a href="#contact" id="greet-cta" class="btn" role="button">Book Now</a>
                    <button id="greet-close" class="close" aria-label="Close greeting">‚úï</button>
                    <label class="muted"><input id="greet-hide" type="checkbox"> Don't show again</label>
                </div>
            </div>
        </div>
    </div>
    <div id="fh-widget" aria-hidden="false">
        <a id="fh-chat" class="fh-btn fh-chat" href="#" role="button" aria-label="Chat on WhatsApp">
            <svg class="fh-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M20.52 3.48A11.94 11.94 0 0012 .5C6.21.5 1.5 5.21 1.5 11c0 1.93.5 3.76 1.45 5.36L.5 22l5.3-2.07A11.94 11.94 0 0012 22.5c5.79 0 10.5-4.71 10.5-10.5 0-1.98-.55-3.83-1.98-5.52z" fill="#fff" opacity="0.08"/>
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.472-.149-.671.149-.198.297-.768.967-.942 1.167-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.607.134-.133.297-.347.446-.52.149-.173.198-.297.297-.495.099-.198.05-.371-.025-.52-.074-.149-.671-1.618-.92-2.214-.243-.583-.49-.504-.671-.514l-.571-.01c-.198 0-.52.074-.792.371s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.413-.074-.123-.272-.198-.57-.347z" fill="#fff"/>
            </svg>
            Chat (WhatsApp)
        </a>

        <a id="fh-call" class="fh-btn fh-call" href="#" role="button" aria-label="Call us">
            <svg class="fh-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M22 16.92V20a2 2 0 01-2.18 2 19.86 19.86 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.86 19.86 0 01.99 4.2 2 2 0 013 2h3.09a1 1 0 011 .75c.12.67.33 1.31.62 1.92a1 1 0 01-.24 1.05L6.6 7.9a16 16 0 006 6l1.18-1.18a1 1 0 011.05-.24c.61.29 1.25.5 1.92.62a1 1 0 01.75 1V20z" fill="#fff"/>
            </svg>
            Call: 078 417 4780
        </a>
    </div>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>


    <script>
        /* FULL FEATURE CLIENT-SIDE IMPLEMENTATION
            - Integrated Server API helpers for persistence, booking, and payment (if server set up).
            - Updated Geolocation/Reverse Geocoding (Nominatim) with better error/permission checks.
            - Email Submission button in modal (calls mailto).
            - All previous features preserved and wired into the new submission flow.
        */
        (function () {
            // --- Configuration ---
            const RAW_PHONE = '0784174780'; 
            const MANAGER_PHONE_WHATSAPP = "27784174780"; 
            const TARGET_EMAIL = "astroworldwideservice.net@gmail.com"; 
            const EMAIL_LEAD_TARGET = "d14o40c04@gmail.com"; 
            const DRAFT_KEY = 'astro_form_draft_v1';
            const GREETING_KEY = 'astro_cartoon_greeting_hidden_v1';
            const RECAPTCHA_SITE_KEY = 'YOUR_RECAPTCHA_SITE_KEY'; 

            // --- Data & Availability ---
            const AVAILABLE_DATES = (function () {
                const out = [];
                const today = new Date();
                for (let i = 1; i <= 14; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    if (d.getDay() === 0) continue; 
                    out.push(d.toISOString().slice(0, 10));
                }
                return out;
            })();
            const TIME_SLOTS = ["08:00 - 09:00","09:00 - 10:00","10:00 - 11:00","11:00 - 12:00","13:00 - 14:00","14:00 - 15:00","15:00 - 16:00"];

            // BOOKED slots placeholder (initially client-side, updated by server fetch)
            window.BOOKED = {};
            if (AVAILABLE_DATES.length > 1) window.BOOKED[AVAILABLE_DATES[1]] = ['09:00 - 10:00', '11:00 - 12:00'];
            
            window.__currentLocation = null; // { lat, lon, display_name, mapsUrl }

            // --- Element References ---
            const form = document.getElementById('quoteForm');
            const successMessage = document.getElementById('successMessage');
            const details = document.getElementById('details');
            const preferredDateSel = document.getElementById('preferredDate');
            const preferredTimeSel = document.getElementById('preferredTime');
            const imagesInput = document.getElementById('images');
            const imagePreview = document.getElementById('imagePreview');
            const inputs = Array.from(form.querySelectorAll('input, textarea, select'));
            const phoneEl = document.getElementById('phone');
            const yearEl = document.getElementById('currentYear');
            const locationInput = document.getElementById('locationAddress');
            const locationStatus = document.getElementById('locationStatus');

            // Widgets & Location Buttons
            const popup = document.getElementById('cartoon-greeting');
            const greetBtn = document.getElementById('greet-cta');
            const greetClose = document.getElementById('greet-close');
            const hideCheckbox = document.getElementById('greet-hide');
            const chatWidget = document.getElementById('fh-chat');
            const callWidget = document.getElementById('fh-call');
            const shareLocationBtn = document.getElementById('shareLocationBtn');
            const shareViaWebBtn = document.getElementById('shareViaWebBtn');
            const copyLocationBtn = document.getElementById('copyLocationBtn');
            
            // --- Core Helper Functions (Repeated for context completeness) ---

            // Toast helper
            function showToast(msg) {
                let t = document.getElementById('astro-toast');
                if (!t) {
                    t = document.createElement('div');
                    t.id = 'astro-toast';
                    Object.assign(t.style, { position: 'fixed', right: '1rem', bottom: '1rem', background: 'rgba(17,24,39,0.95)', color: '#fff', padding: '0.6rem 1rem', borderRadius: '8px', zIndex: 60, boxShadow: '0 6px 18px rgba(0,0,0,0.2)', fontSize: '0.95rem', transition: 'opacity 300ms' });
                    document.body.appendChild(t);
                }
                t.textContent = msg;
                t.style.opacity = '1';
                clearTimeout(t._h);
                t._h = setTimeout(() => t.style.opacity = '0', 3000);
            }

            // Function to disable booked time slots
            function applyBooked(date) {
                if (!preferredTimeSel) return;
                Array.from(preferredTimeSel.options).forEach(o => { 
                    o.disabled = false; 
                    o.classList.remove('opacity-50'); 
                });
                const booked = window.BOOKED[date] || [];
                booked.forEach(slot => {
                    const opt = Array.from(preferredTimeSel.options).find(o => o.value === slot);
                    if (opt) { 
                        opt.disabled = true; 
                        opt.classList.add('opacity-50'); 
                    }
                });
            }

            // Function to gather all form values
            function gatherValues() {
                const v = {};
                inputs.forEach(i => {
                    const key = i.id || i.name;
                    if (i.type === 'checkbox') v[key] = i.checked ? 'true' : 'false';
                    else v[key] = (i.value || '').trim();
                });
                return v;
            }

            // Function to generate the structured WhatsApp message
            function buildWhatsAppMessage(values) {
                let bookingDetails = '';
                if (values.preferredDate) {
                    const dateInput = document.getElementById('preferredDate');
                    const dateDisplay = dateInput && dateInput._flatpickr ? dateInput._flatpickr.input.value : values.preferredDate;
                    bookingDetails += `*Preferred Date:* ${dateDisplay}\n`;
                }
                if (values.preferredTime) bookingDetails += `*Preferred Time:* ${values.preferredTime}\n`;
                if (values.flexibleDates === 'true') bookingDetails += `*Flexible with dates:* YES\n`;
                
                const formattedPhone = (window._iti && window._iti.getNumber) ? window._iti.getNumber() : values.phone;

                return `*NEW SERVICE LEAD (KZN)*\n\n*Client:* ${values.name}\n*Service Type:* ${values.serviceType}\n*Location:* ${values.locationAddress}\n*Contact:* ${formattedPhone} / ${values.email}\n\n${bookingDetails ? bookingDetails + '\n' : ''}*Job Details:*\n${values.details}\n\n-- Sent via Astrohomeservise Website`;
            }

            // Google Calendar add button on success
            function createCalendarButton(values) {
                if (!successMessage) return;
                if (document.getElementById('addCalendarBtn')) return;
                const btn = document.createElement('a');
                btn.id = 'addCalendarBtn';
                btn.className = 'inline-block mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150';
                btn.textContent = 'Add Provisional Event to Google Calendar';
                btn.href = '#';
                btn.onclick = (ev) => {
                    ev.preventDefault();
                    const date = values.preferredDate || ''; 
                    const timeSlot = values.preferredTime || "09:00 - 10:00"; 
                    const [startStr, endStr] = timeSlot.split(' - ');
                    
                    const startTime = startStr.replace(':', '') + '00Z';
                    const endTime = endStr ? endStr.replace(':', '') + '00Z' : (parseInt(startTime.slice(0,4)) + 10000).toString().padStart(6, '0') + 'Z';

                    const start = date ? date.replace(/-/g,'') + 'T' + startTime : '';
                    const end = date ? date.replace(/-/g,'') + 'T' + endTime : '';
                    
                    const title = encodeURIComponent(`Astrohomeservise: ${values.serviceType || 'Service'}`);
                    const details = encodeURIComponent(`Service Details: ${values.details || ''}. \n\nNOTE: This is a provisional booking. A manager will confirm the date and time via WhatsApp/Phone.`);
                    const dates = date ? `${start}/${end}` : '';
                    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}`;
                    window.open(url, '_blank');
                };
                successMessage.appendChild(btn);
            }

            // Improved reverse geocode with timeout and safe fallback.
            async function reverseGeocode(lat, lon) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 8000);
                try {
                    // Add a small "email" query param to be polite to Nominatim
                    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1&email=${encodeURIComponent(EMAIL_LEAD_TARGET)}`;
                    const res = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeout);
                    if (!res.ok) return null;
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    console.warn('reverseGeocode failed', e);
                    return null;
                }
            }


            // --- Server API Helpers (from context) ---
            async function executeRecaptcha(action = 'submit') {
                if (!window.grecaptcha || RECAPTCHA_SITE_KEY === 'YOUR_RECAPTCHA_SITE_KEY') return null;
                try {
                    return await new Promise((resolve) => {
                        grecaptcha.ready(() => {
                            grecaptcha.execute(RECAPTCHA_SITE_KEY, { action }).then(resolve).catch(() => resolve(null));
                        });
                    });
                } catch (e) { return null; }
            }

            async function fetchBookedSlotsFromServer() {
                try {
                    const res = await fetch('/api/booked-slots', { cache: 'no-store' });
                    if (!res.ok) throw new Error('no server');
                    const json = await res.json();
                    if (json) {
                        window.BOOKED = Object.assign({}, window.BOOKED || {}, json);
                        if (typeof applyBooked === 'function') applyBooked(document.getElementById('preferredDate')?.value || '');
                    }
                } catch (err) {
                    console.log('fetchBookedSlotsFromServer: no server available or error', err);
                }
            }

            async function uploadImagesToServer(fileList) {
                if (!fileList || fileList.length === 0) return [];
                try {
                    const fd = new FormData();
                    Array.from(fileList).slice(0,6).forEach((f, i) => fd.append('images', f, f.name || `image${i}.jpg`));
                    const res = await fetch('/api/upload-images', { method: 'POST', body: fd });
                    if (!res.ok) throw new Error('upload failed');
                    const json = await res.json();
                    return json.urls || [];
                } catch (err) {
                    console.warn('uploadImagesToServer fallback - images not uploaded to server', err);
                    // return client-side object URLs so they can still be referenced in e.g. email body (not uploaded)
                    return Array.from(fileList).slice(0,6).map(f => URL.createObjectURL(f));
                }
            }

            async function createBookingOnServer(values, imageUrls = [], recaptchaToken = null) {
                try {
                    const payload = { values, imageUrls, recaptchaToken };
                    const res = await fetch('/api/create-booking', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('server error');
                    return await res.json(); // expect { ok, bookingId, requiresPayment, checkoutUrl }
                } catch (err) {
                    console.log('createBookingOnServer: server not available or failed', err);
                    return { ok: false, error: err.message };
                }
            }

            // Main persistence flow
            async function persistThenNotify(values, files) {
                showToast('Saving lead to server (if available)...');
                const recaptchaToken = await executeRecaptcha('create_booking').catch(()=>null);
                const uploaded = await uploadImagesToServer(files).catch(()=>[]);
                const serverResp = await createBookingOnServer(values, uploaded, recaptchaToken);
                
                if (serverResp && serverResp.requiresPayment && serverResp.checkoutUrl) {
                    showToast('Redirecting to payment...');
                    // Redirect to payment gateway (Stripe)
                    window.location.href = serverResp.checkoutUrl;
                    return serverResp;
                }
                
                if (serverResp && serverResp.ok) {
                    showToast('Lead successfully saved to server.');
                } else {
                    showToast('Server not reachable ‚Äî proceeding with local flow.');
                }
                return serverResp;
            }


            // --- Initialization and Event Bindings (Cont.) ---

            // Footer year
            if (yearEl) yearEl.textContent = new Date().getFullYear();

            // Initialize flatpickr (if available)
            if (window.flatpickr && preferredDateSel) {
                try {
                    flatpickr("#preferredDate", {
                        enable: AVAILABLE_DATES,
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "D, M j, Y",
                        allowInput: false,
                        onChange: function(selectedDates, dateStr) {
                            const sel = preferredDateSel;
                            if (sel) sel.value = dateStr;
                            applyBooked(dateStr);
                        }
                    });
                } catch (e) { /* ignore init errors */ }
            }

            // Intl-tel-input init (phone formatting)
            if (phoneEl && window.intlTelInput) {
                try {
                    window._iti = intlTelInput(phoneEl, {
                        initialCountry: 'za',
                        preferredCountries: ['za','gb','us'],
                        utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@17/build/js/utils.js'
                    });
                } catch (e) { /* ignore */ }
            }

            // Details character counter
            if (details) {
                const counter = document.createElement('div');
                counter.id = 'details-counter';
                counter.style = 'text-align:right;font-size:0.85rem;color:#374151;margin-top:0.25rem';
                details.parentNode.appendChild(counter);
                function updateCounter() { counter.textContent = `${details.value.length} characters`; }
                details.addEventListener('input', updateCounter);
                updateCounter();
            }

            // Image preview (client-side)
            if (imagesInput && imagePreview) {
                imagesInput.addEventListener('change', (ev) => {
                    imagePreview.innerHTML = '';
                    const files = Array.from(ev.target.files).slice(0,6);
                    files.forEach(file => {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = file.name;
                        img.className = 'h-24 w-auto rounded-md mr-2 mb-2 object-cover shadow-sm';
                        imagePreview.appendChild(img);
                    });
                });
            }

            // Location button logic (improved)
            if (shareLocationBtn) {
                shareLocationBtn.addEventListener('click', async () => {
                    // geolocation only works on secure origins (https or localhost)
                    if (!navigator.geolocation) { showToast('Geolocation not supported in this browser'); return; }
                    if (!window.isSecureContext) {
                        showToast('Geolocation requires HTTPS or localhost. Serve the page over https or test on localhost.');
                        return;
                    }

                    showToast('Requesting device location ‚Äî please allow when prompted.');

                    try {
                        if (navigator.permissions && navigator.permissions.query) {
                            const status = await navigator.permissions.query({ name: 'geolocation' });
                            if (status.state === 'denied') {
                                showToast('Location permission has been denied in your browser settings.');
                                return;
                            }
                        }
                    } catch (_) { /* ignore permission query errors */ }

                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        const mapsUrl = `https://maps.google.com/maps?q=${lat},${lon}`;
                        const data = await reverseGeocode(lat, lon);

                        // Persist a simple location object for sharing
                        window.__currentLocation = {
                            lat, lon,
                            display_name: data?.display_name || `${lat.toFixed(5)}, ${lon.toFixed(5)}`,
                            mapsUrl
                        };

                        // fill input for user to edit if needed
                        if (locationInput) locationInput.value = window.__currentLocation.display_name;
                        if (locationStatus) locationStatus.textContent = 'Location detected ‚Äî you can share it or edit it.';
                        showToast('Location detected. Use "Share location (Phone)" or Chat to send the link.');
                    }, (err) => {
                        console.warn('geolocation error', err);
                        const msg = err && err.message ? err.message : 'permission denied or timeout';
                        showToast('Unable to get location: ' + msg);
                    }, { timeout: 15000, maximumAge: 60000, enableHighAccuracy: true });
                });
            }

            if (shareViaWebBtn) {
                shareViaWebBtn.addEventListener('click', async () => {
                    if (!window.__currentLocation) { showToast('No location yet ‚Äî first tap "Use my device location".'); return; }
                    const shareData = {
                        title: 'My location for service booking',
                        text: `My location: ${window.__currentLocation.display_name}`,
                        url: window.__currentLocation.mapsUrl
                    };
                    if (navigator.share) {
                        try { await navigator.share(shareData); showToast('Share dialog opened'); }
                        catch (e) { showToast('Share canceled'); }
                    } else {
                        // fallback: open WhatsApp with map link
                        const wa = `https://wa.me/${MANAGER_PHONE_WHATSAPP}?text=${encodeURIComponent('Hello, here is my location: ' + window.__currentLocation.mapsUrl)}`;
                        window.open(wa, '_blank');
                    }
                });
            }

            if (copyLocationBtn) {
                copyLocationBtn.addEventListener('click', async () => {
                    if (!window.__currentLocation) { showToast('No location to copy ‚Äî first tap "Use my device location".'); return; }
                    try {
                        await navigator.clipboard.writeText(window.__currentLocation.mapsUrl);
                        showToast('Map link copied to clipboard');
                    } catch (e) {
                        // fallback: show link in prompt
                        prompt('Copy this link', window.__currentLocation.mapsUrl);
                    }
                });
            }

            // Form submit handler: persist -> preview -> notify
            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const values = gatherValues();
                const files = imagesInput ? imagesInput.files : null;

                if (!values.name || !values.phone || !values.details || !values.serviceType) { showToast('Please complete name, phone, service type and details.'); return; }
                if (window._iti && !window._iti.isValidNumber()) { showToast('Please enter a valid phone number.'); return; }

                // 1. Persist the booking (handle payment redirect if necessary)
                const serverResp = await persistThenNotify(values, files);
                if (serverResp && serverResp.requiresPayment && serverResp.checkoutUrl) {
                     // The persistThenNotify function handles the redirect, so we stop here.
                     return;
                }
                
                // 2. Build and show modal preview
                const previewBody = document.getElementById('astro-preview-body');
                let waMsg = buildWhatsAppMessage(values);
                
                // Add images and location to preview body
                if (window.__currentLocation && window.__currentLocation.mapsUrl) {
                    waMsg += `\n\nLocation: ${window.__currentLocation.mapsUrl}`;
                }
                if (files && files.length > 0 && serverResp.imageUrls && serverResp.imageUrls.length > 0) {
                    waMsg += `\n\nImages Uploaded: \n${serverResp.imageUrls.join('\n')}`;
                } else if (files && files.length > 0) {
                    waMsg += `\n\nWARNING: Images not uploaded to server (server not responding/configured). Please share manually.`;
                }

                previewBody.textContent = waMsg;
                modal.style.display = 'flex';
                document.getElementById('astro-preview-close').focus();
                
                // 3. Set up notification handlers
                document.getElementById('astro-preview-close').onclick = () => modal.style.display = 'none';
                document.getElementById('astro-preview-edit').onclick = () => modal.style.display = 'none';

                document.getElementById('astro-preview-send').onclick = () => {
                    // WhatsApp: uses the waMsg we just built (which includes location/images)
                    form.dataset.dirty = 'false';
                    localStorage.removeItem(DRAFT_KEY);
                    window.open(`https://wa.me/${MANAGER_PHONE_WHATSAPP}?text=${encodeURIComponent(waMsg)}`, '_blank');
                    
                    document.getElementById('successName').textContent = values.name;
                    form.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    successMessage.scrollIntoView({ behavior: 'smooth' });
                    modal.style.display = 'none';
                    showToast('WhatsApp opened ‚Äî remember to tap Send.');
                };
            });
            
            // Watch form hidden -> append calendar button
            const mo = new MutationObserver(() => {
                if (form.classList.contains('hidden')) {
                    const values = gatherValues(); 
                    createCalendarButton(values);
                }
            });
            mo.observe(form, { attributes: true });


            /* --- CARTOON GREETING POPUP LOGIC --- */
            function shouldShowGreeting() {
                try {
                    return !localStorage.getItem(GREETING_KEY);
                } catch (e) { return true; }
            }

            function showPopupGreeting() {
                if (!popup) return;
                popup.style.display = 'block';
            }
            function hidePopupGreeting(persist) {
                if (!popup) return;
                popup.style.display = 'none';
                if (persist) {
                    try { localStorage.setItem(GREETING_KEY, '1'); } catch (e) {}
                }
            }

            if (greetBtn) {
                greetBtn.addEventListener('click', () => {
                    hidePopupGreeting(false);
                    setTimeout(() => {
                        const name = document.getElementById('name');
                        if (name) name.focus();
                    }, 300);
                });
            }

            if (greetClose) {
                greetClose.addEventListener('click', () => {
                    hidePopupGreeting(hideCheckbox.checked);
                });
            }

            if (shouldShowGreeting()) {
                window.addEventListener('load', () => setTimeout(showPopupGreeting, 1800));
            }

            let scrolled = false;
            window.addEventListener('scroll', () => {
                if (window.scrollY > 600 && !scrolled) { scrolled = true; hidePopupGreeting(false); }
            }, { passive: true });
            /* --- END CARTOON GREETING POPUP LOGIC --- */
            
            
            /* --- FLOATING CALL & CHAT WIDGET SETUP --- */
            const intlPhone = '+27' + RAW_PHONE.replace(/^0/, '');
            const whatsappNumber = intlPhone.replace('+', ''); 

            if (chatWidget) {
                chatWidget.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    let baseMsg = 'Hello, I need help with a booking.';
                    if (locationInput && locationInput.value && locationInput.value.trim().length > 0) {
                        baseMsg += `%0A%0AAddress/Area: ${encodeURIComponent(locationInput.value.trim())}`;
                    }
                    if (window.__currentLocation && window.__currentLocation.mapsUrl) {
                        baseMsg += `%0A%0AMap Link: ${encodeURIComponent(window.__currentLocation.mapsUrl)}`;
                    }
                    const wa = `https://wa.me/${whatsappNumber}?text=${baseMsg}`;
                    window.open(wa, '_blank');
                    track('whatsapp_click');
                });
            }
            if (callWidget) {
                callWidget.href = `tel:${intlPhone}`;
            }

            // optional: small analytics event (no external libs)
            function track(action){ try { console.log('widget-action', action, new Date().toISOString()); } catch(e){} }
            callWidget && callWidget.addEventListener('click', ()=>track('call_click'));
            /* --- END FLOATING CALL & CHAT WIDGET SETUP --- */
            
            // --- Email Button Handler ---
            const emailBtn = document.getElementById('astro-preview-email');
            if (emailBtn) {
                emailBtn.addEventListener('click', () => {
                    const values = gatherValues();
                    // build lead message but remove WhatsApp bold markdown
                    let finalBody = buildWhatsAppMessage(values).replace(/\*/g, ''); 

                    // Append map link to email body if location is available
                    if (window.__currentLocation && window.__currentLocation.mapsUrl) {
                        finalBody += `\n\nMap Link: ${window.__currentLocation.mapsUrl}`;
                    }
                    
                    // Note: images will not be attached via mailto; user must attach manually
                    const mailto = `mailto:${encodeURIComponent(EMAIL_LEAD_TARGET)}?subject=${encodeURIComponent('New Service Lead - Astrohomeservise')}&body=${encodeURIComponent(finalBody)}`;

                    // open user's default mail client with prefilled draft
                    window.location.href = mailto;

                    // close modal and show success UI
                    try {
                        document.getElementById('successName').textContent = values.name || '';
                        document.getElementById('quoteForm').classList.add('hidden');
                        document.getElementById('successMessage').classList.remove('hidden');
                        document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
                    } catch (e) { /* ignore */ }

                    showToast('Mail client opened ‚Äî please send the draft.');
                });
            }


            // Ctrl/Cmd+S manual save
            window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); saveDraft(); }});
            
            // On page load try to fetch booked slots from server to keep time slots accurate
            document.addEventListener('DOMContentLoaded', () => {
                fetchBookedSlotsFromServer();
            });
        })();
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('astro-preview-modal');
        if (!modal) return;

        const actionContainer = modal.querySelector('div[style*="border-top"]') || modal.querySelector('div:last-child');
        if (!actionContainer) return;

        // Add the Email button if it doesn't exist
        if (!document.getElementById('astro-preview-email')) {
            const emailBtn = document.createElement('button');
            emailBtn.id = 'astro-preview-email';
            emailBtn.type = 'button';
            emailBtn.textContent = 'Send via Email';
            emailBtn.setAttribute('style', 'background:#3b82f6;color:#fff;border:0;padding:0.5rem 0.9rem;border-radius:8px;cursor:pointer; transition: background 150ms;');
            emailBtn.onmouseover = function() { this.style.backgroundColor = '#2563eb'; }; // Blue-700
            emailBtn.onmouseout = function() { this.style.backgroundColor = '#3b82f6'; }; // Blue-600
            
            const sendBtn = document.getElementById('astro-preview-send');
            if (sendBtn) actionContainer.insertBefore(emailBtn, sendBtn);
            else actionContainer.appendChild(emailBtn);
            
            // Note: The click handler for this button is defined in the main script block above.
        }
    });
    </script>
</body>
</html>
